{{ define "main" }}

<h1>Graph {{ .Title }}</h1>

{{ .Content }}

<div>
  <ul id="radio-buttons"></ul>
  <canvas id="myChart"></canvas>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>


<script>
  const radioContainer = document.getElementById("radio-buttons");

  // Load the JSON data from an external file
  fetch('{{ relURL "graph.json"}}')
    .then(response => {
      if (!response.ok) {
        throw new Error(`HTTP error! Status: ${response.status}`);
      }
      return response.json();
    })
    .then(data => {
      const uniqueNames = [...new Set(data.map(item => item.name))].sort();
      const ctx = document.getElementById('myChart').getContext('2d');

      // draw radio buttons for each chart
      uniqueNames.forEach((name, index) => {
        let radio = document.createElement("input");
        radio.type = "radio";
        radio.name = "chart-selector";
        radio.value = name;
        radio.id = `radio-${name}`;
        if (index === 0) radio.checked = true; // Default selection
    
        let label = document.createElement("label");
        label.htmlFor = `radio-${name}`;
        label.innerText = name;
        label.classList.add("px-2")

        radio.addEventListener("change", () => updateChart(name, index));
        let li = document.createElement("li");

        li.appendChild(radio);
        li.appendChild(label);
        radioContainer.appendChild(li);
      });
      
      // Assign a random color to each unique name
      const colorMap = {};
      uniqueNames.forEach(name => {
        colorMap[name] = `hsl(${Math.floor(Math.random() * 360)}, 70%, 50%)`;
      });

      let titleText = "not implemented for {{ .Params.graph }}"
      let dataCallback = null
      let y = {
        title: {
          display: true,
          text: 'Duration (MM:SS)'
        },
        ticks: {
          callback: function (value) {
            const minutes = Math.floor(value / 60);
            const seconds = value % 60;
            return `${minutes}:${seconds.toString().padStart(2, '0')}`;
          }
        },
        beginAtZero: true
      }

      // for EXECUTION-DURATION chart
      {{ with (eq .Params.graph "execution") }}
        titleText = "task execution duration"
        dataCallback = (data, name) => data
            .filter(item => item.name === name)
            .map(item => ({ x: item.created, y: item.duration, task: item.id }))
      {{ end }}
      // for EXECUTION+SCHEDULE-DURATION chart
      {{ with (eq .Params.graph "schedule+execution") }}
        titleText = "task schedule + execution duration"
        dataCallback = (data, name) => data
            .filter(item => item.name === name)
            .map(item => ({ x: item.created, y: item.duration + item.scheduleDuration, task: item.id })) 
      {{ end }}
      // for CCACHE chart
      {{ with (eq .Params.graph "ccache") }}
        titleText = "ccache hitrate"
        dataCallback = (data, name) => data
            .filter(item => item.name === name)
            .filter(item => item.ccacheHitrate > 0)
            .map(item => ({ x: item.created, y: item.ccacheHitrate, task: item.id }))
        y = {
          title: {
            display: true,
            text: "hitrate [%]"
          },
          beginAtZero: true
        }
      {{ end }}
      
      // Group data points by name
      const datasets = uniqueNames.map(name => {
        return {
          label: name,
          data: dataCallback(data, name),
          borderColor: colorMap[name],
          backgroundColor: colorMap[name],
          fill: false,
          tension: 0.1
        };
      });

      // Create the Chart.js line chart
      let currentChart = new Chart(ctx, {
        type: 'scatter',
        data: {
          datasets: [datasets[0]],
        },
        options: {
          animation: false,
          responsive: true,
          onClick: (event, elements) => {
            if (elements.length > 0) {              
                const taskid = elements[0].element.$context.raw.task
                window.open('{{ relURL "task"  }}/' + taskid + "/", "_blank");
            }
          },
          scales: {
            x: {
              type: 'time', // Use time scale for x-axis
              time: {
                unit: 'day', // Adjust unit based on data (e.g., 'day', 'hour', 'minute')
                tooltipFormat: 'PPpp', // Format for tooltip (uses date-fns)
              },
              title: {
                display: true,
                text: 'task created timestamp'
              }
            },
            y: y, 
          },
          plugins: {
            legend: {
              position: 'top'
            },
            title: {
              display: true,
              text: titleText
            },
          }
        }
      });

      function updateChart(selectedName, index) {
        currentChart.data.datasets = [datasets[index]];
        currentChart.update();
      }

    })
    .catch(error => {
      console.error('Error loading the JSON data:', error);
    });
</script>

{{ end }}
